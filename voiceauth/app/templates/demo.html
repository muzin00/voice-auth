<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceAuth - Voice Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .recording { animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .digit-display {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5em;
        }
        .record-btn {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">VoiceAuth Demo</h1>
            <p class="text-gray-600 mt-2">Voice Authentication</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex mb-6 bg-white rounded-lg shadow">
            <button id="tab-enroll" onclick="switchTab('enroll')"
                    class="flex-1 py-3 px-4 text-center font-medium rounded-l-lg bg-blue-500 text-white">
                話者登録
            </button>
            <button id="tab-verify" onclick="switchTab('verify')"
                    class="flex-1 py-3 px-4 text-center font-medium rounded-r-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                認証
            </button>
        </div>

        <!-- Enrollment Section -->
        <section id="section-enroll" class="bg-white rounded-lg shadow p-6">
            <!-- Initial Form -->
            <div id="enroll-form">
                <h2 class="text-xl font-semibold mb-4">話者登録</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Speaker ID</label>
                        <input type="text" id="enroll-speaker-id"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="例: user123">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">名前（任意）</label>
                        <input type="text" id="enroll-speaker-name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="例: 山田太郎">
                    </div>
                    <button onclick="startEnrollment()"
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">
                        登録を開始
                    </button>
                </div>
            </div>

            <!-- Recording UI -->
            <div id="enroll-recording" class="hidden">
                <h2 class="text-xl font-semibold mb-4">音声録音</h2>

                <!-- Progress -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>進捗</span>
                        <span id="enroll-progress-text">0 / 5</span>
                    </div>
                    <div class="flex space-x-2">
                        <div id="progress-1" class="h-2 flex-1 rounded bg-gray-200"></div>
                        <div id="progress-2" class="h-2 flex-1 rounded bg-gray-200"></div>
                        <div id="progress-3" class="h-2 flex-1 rounded bg-gray-200"></div>
                        <div id="progress-4" class="h-2 flex-1 rounded bg-gray-200"></div>
                        <div id="progress-5" class="h-2 flex-1 rounded bg-gray-200"></div>
                    </div>
                </div>

                <!-- Prompt Display -->
                <div class="text-center py-8 bg-gray-50 rounded-lg mb-4">
                    <p class="text-sm text-gray-500 mb-2">以下の数字を発話してください</p>
                    <p id="enroll-prompt" class="text-5xl font-bold digit-display text-blue-600">----</p>
                </div>

                <!-- Record Button -->
                <div class="text-center mb-4">
                    <button id="enroll-record-btn"
                            class="record-btn w-32 h-32 rounded-full bg-red-500 text-white text-lg font-medium hover:bg-red-600 transition flex items-center justify-center mx-auto shadow-lg">
                        <span id="enroll-record-text">押しながら<br>話す</span>
                    </button>
                </div>

                <!-- Feedback -->
                <div id="enroll-feedback" class="text-center p-4 rounded-lg bg-gray-50">
                    <p class="text-gray-600">ボタンを押しながら数字を発話してください</p>
                </div>
            </div>

            <!-- PIN Registration -->
            <div id="enroll-pin" class="hidden">
                <h2 class="text-xl font-semibold mb-4">PIN設定</h2>
                <p class="text-gray-600 mb-4">バックアップ認証用の4桁PINを設定してください</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PIN（4桁）</label>
                        <input type="password" id="enroll-pin-input" maxlength="4" pattern="[0-9]{4}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl tracking-widest"
                               placeholder="****">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PIN（確認）</label>
                        <input type="password" id="enroll-pin-confirm" maxlength="4" pattern="[0-9]{4}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl tracking-widest"
                               placeholder="****">
                    </div>
                    <button onclick="submitPin()"
                            class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition">
                        登録完了
                    </button>
                </div>
            </div>

            <!-- Completion -->
            <div id="enroll-complete" class="hidden text-center py-8">
                <div class="text-green-500 text-6xl mb-4">&#10003;</div>
                <h2 class="text-2xl font-semibold text-green-600 mb-2">登録完了</h2>
                <p class="text-gray-600 mb-4">話者登録が正常に完了しました</p>
                <button onclick="resetEnrollment()"
                        class="bg-blue-500 text-white py-2 px-6 rounded-md hover:bg-blue-600 transition">
                    新規登録
                </button>
            </div>
        </section>

        <!-- Verification Section -->
        <section id="section-verify" class="bg-white rounded-lg shadow p-6 hidden">
            <!-- Initial Form -->
            <div id="verify-form">
                <h2 class="text-xl font-semibold mb-4">認証</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Speaker ID</label>
                        <input type="text" id="verify-speaker-id"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="例: user123">
                    </div>
                    <button onclick="startVerification()"
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">
                        認証を開始
                    </button>
                </div>
            </div>

            <!-- Recording UI -->
            <div id="verify-recording" class="hidden">
                <h2 class="text-xl font-semibold mb-4">音声認証</h2>

                <!-- Prompt Display -->
                <div class="text-center py-8 bg-gray-50 rounded-lg mb-4">
                    <p class="text-sm text-gray-500 mb-2">以下の数字を発話してください</p>
                    <p id="verify-prompt" class="text-5xl font-bold digit-display text-blue-600">----</p>
                </div>

                <!-- Record Button -->
                <div class="text-center mb-4">
                    <button id="verify-record-btn"
                            class="record-btn w-32 h-32 rounded-full bg-red-500 text-white text-lg font-medium hover:bg-red-600 transition flex items-center justify-center mx-auto shadow-lg">
                        <span id="verify-record-text">押しながら<br>話す</span>
                    </button>
                </div>

                <!-- Divider -->
                <div class="flex items-center my-4">
                    <div class="flex-1 border-t border-gray-300"></div>
                    <span class="px-3 text-sm text-gray-500">または</span>
                    <div class="flex-1 border-t border-gray-300"></div>
                </div>

                <!-- File Upload -->
                <div class="text-center mb-4">
                    <label for="verify-file-input"
                           class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition cursor-pointer shadow">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        音声ファイルをアップロード
                    </label>
                    <input type="file" id="verify-file-input"
                           accept="audio/*,.wav,.webm,.mp3,.flac,.ogg,.m4a"
                           class="hidden"
                           onchange="handleVerifyFileUpload(this)">
                    <p class="text-xs text-gray-400 mt-2">WAV, WebM, MP3, FLAC, OGG, M4A に対応</p>
                </div>

                <!-- Feedback -->
                <div id="verify-feedback" class="text-center p-4 rounded-lg bg-gray-50">
                    <p class="text-gray-600">ボタンを押しながら発話、またはファイルをアップロードしてください</p>
                </div>
            </div>

            <!-- Result -->
            <div id="verify-result" class="hidden">
                <h2 class="text-xl font-semibold mb-4">認証結果</h2>

                <div id="verify-result-content" class="space-y-4">
                    <!-- Results will be dynamically inserted here -->
                </div>

                <!-- PIN Fallback -->
                <div id="verify-pin-fallback" class="hidden mt-6 pt-6 border-t">
                    <h3 class="font-medium mb-3">PIN認証</h3>
                    <div class="flex space-x-2">
                        <input type="password" id="verify-pin-input" maxlength="4" pattern="[0-9]{4}"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-xl tracking-widest"
                               placeholder="****">
                        <button onclick="submitVerifyPin()"
                                class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">
                            認証
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-6 flex space-x-4">
                    <button onclick="resetVerification()"
                            class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition">
                        やり直す
                    </button>
                </div>
            </div>
        </section>

        <!-- Error Display -->
        <div id="error-toast" class="fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden">
            <p id="error-message"></p>
        </div>
    </div>

    <script src="/static/js/demo.js"></script>
</body>
</html>
